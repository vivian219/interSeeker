<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Semantic UI</title>
	<script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
	<link rel="stylesheet" type="text/css" href="static/semantic/dist/semantic.min.css">
	<script type="text/javascript" src="static/semantic/dist/semantic.min.js"></script>
	<script type="text/javascript" src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
	<script type="text/javascript" src="https://cdn.datatables.net/1.10.16/js/dataTables.semanticui.min.js"></script>
    <link rel="stylesheet" type="text/css" href="static/css/list.css">
	<style type="text/css">
		.list-hidden {
            display: none;
            color: #2B2B2B;
        }
        .long-input {
        	width: 75%;
        }
        .bottom-line {
  			border-left:none;
    		border-right:none;
  			border-top:none;
        }
        .black {
        	color: black;
        }
	</style>
</head>
<body>
<div class="ui inverted segment">
  <div class="ui inverted secondary menu">
  	<div class="item" >
       <img  src="static/images/icon1.png">
	   <a href="index.html"><span style="font-size: medium;">&nbsp;IntelTrackr</span> </a>
	</div>
    <a class="item" href="manege-list.html">
      Info List
    </a>
    <a class="item active">
      Actor List
    </a>
    <a class="item" href="audit.html">
      Verify
    </a>
    <div class="right menu">
	  <div class="item">
		<p style="font-family: '微软雅黑'; font-style: italic;">Administrator</p>
	  </div>
	  <a class="ui item" onclick="toggleLogin()">
	    Logout
	  </a>
	</div>
  </div>
</div>
<div class="ui container">
	<!-- <div class="ui grid"> -->
	<div class="ui hidden divider"></div>
	<table id="example" class="display ui celled table" cellspacing="0" width="100%">
        <thead>
            <tr>
                <th>ID</th>
                <th>Actor Name</th>
                <th>首次观测时间</th>
                <th>危险程度</th>
                <th>Classification Family</th>
                <th>Classification ID</th>
                <th>操作</th>
            </tr>
        </thead>
        <tfoot>
            <tr>
                <th>序号</th>
                <th>情报标题</th>
                <th>发布日期</th>
                <th>情报来源</th>
                <th>状态</th>
                <th>TLP</th>
                <th>操作</th>
            </tr>
        </tfoot>
    </table>
    <div class="ui grid">
		<div class="centered row">
			<button class="ui basic button" onclick="toggleAdd()">
			  <i class="icon plus"></i>
			  Add Actor
			</button>
		</div>
    </div>
    

    <div class="ui coupled longer details large modal">
      <i class="close icon"></i>
      <div class="header">
      DETAILS
      </div>
      <div class="scrolling content">
        <div class="description ui grid">
          <div class="ui form" onchange="detailModified()">
            <h3><i class="tags icon"></i><span id="title" class="ui long-input tiny icon transparent input disabled black">
                  <input type="text" spellcheck="false" id="a-title" >
                </span></h3>
            <p>威胁程度:　<span class="ui tiny icon transparent input">
                  <input type="text" spellcheck="false" id="a-crit" value="暂无">
                </span>
            观测日期:　<span class="ui tiny icon transparent input">
                  <input type="text" spellcheck="false" id="a-cdate" value="暂无">
                </span></br>
            <p id="aid">ID:　<span id="a-id"></span></br></p></p>
            <div class="ui divider"></div>
            <div>
                <!-- 状态:　<div class="ui label inline-div">已更新</div>　　 -->
                TLP:
                <div class="ui inline dropdown" id="TLPdropdown">
                  <div class="text ui label" id="a-tlp">
                  </div>
                  <i class="dropdown icon"></i>
                  <div class="menu">
                    <div data-value="1" class="item">不可共享
                    </div>
                    <div data-value="2" class="item">组织内共享
                    </div>
                    <div data-value="3" class="item">组织外限制共享
                    </div>
                    <div data-value="4" class="item">广泛共享
                    </div>
                  </div>
                </div>　

                　　Classification Family:
                <div class="ui inline dropdown" id="cfdropdown">
                  <div class="text ui label" id="a-cf">
                  </div>
                  <i class="dropdown icon"></i>
                  <div class="menu">
                    <div data-value="1" class="item">Actors
                    </div>
                    <div data-value="2" class="item">Attack
                    </div>
                    <div data-value="3" class="item">Infrastructure
                    </div>
                    <div data-value="4" class="item">Intel
                    </div>
                    <div data-value="4" class="item">Malicious
                    </div>
                  </div>
                </div>

                　　Classification ID:
                <span class="ui tiny icon transparent input">
                  <input type="text" spellcheck="false" id="a-ci" value="Black Hat">
                </span>
				<div class="ui fitted hidden divider"></div><div class="ui fitted hidden divider"></div>
				Actor Types:
                <div class="ui inline dropdown" id="atpdropdown">
                  <div class="text ui label" id="a-at">
                  </div>
                  <i class="dropdown icon"></i>
                  <div class="menu">
                    <div data-value="1" class="item">Criminal
                    </div>
                    <div data-value="2" class="item">Hacktivist
                    </div>
                    <div data-value="3" class="item">Nation State
                    </div>
                  </div>
                </div>

                　　Motivations:
                <div class="ui inline dropdown" id="mtvdropdown">
                  <div class="text ui label" id="a-m">
                  </div>
                  <i class="dropdown icon"></i>
                  <div class="menu">
                    <div data-value="1" class="item">Unknown
                    </div>
                    <div data-value="2" class="item">Deny
                    </div>
                    <div data-value="3" class="item">degrade
                    </div>
                    <div data-value="4" class="item">disrupt
                    </div>
                    <div data-value="4" class="item">destroy
                    </div>
                    <div data-value="4" class="item">manipulate info or info systems
                    </div>
                    <div data-value="4" class="item">Espionage
                    </div>
                    <div data-value="4" class="item">Extortion
                    </div>
                    <div data-value="4" class="item">Trading information for competitive advantage
                    </div>
                    <div data-value="4" class="item">Other
                    </div>
                  </div>
                </div>

            </div>
            <div class="ui divider"></div>
            <!-- <div>文档标签:　<div class="inline-div" id="labellist">
                    <a class="ui label"><span>公开</span><i class="delete icon" onclick="delLabel(this)"></i></a>
                    <a class="ui label">安全漏洞<i class="delete icon" onclick="delLabel(this)"></i></a>
                </div>
                <a class="ui gray label" onclick="addLabel()"><i class="plus icon"></i>添加</a>
                <div class="ui mini icon transparent input">
                  <input type="text" spellcheck="false" id="newlabel" placeholder="label...">
                </div>
            </div> -->
            <!-- <div class="ui divider"></div> -->
            <h5><i class="file text outline icon"></i>Actor描述</h5>
            <div class="field">
              <textarea spellcheck="false" id="ai-abstract"></textarea>
            </div>
           	<div class="ui divider"></div>
           	Aliases: <span class="ui tiny icon transparent input">
                <input type="text" spellcheck="false" id="ai-al" value="暂无">
            </span>
           	<p></p>
           	Communication Addresses: <span class="ui long-input tiny icon transparent input">
                <input type="text" spellcheck="false" id="ai-cad" value="暂无">
            </span>
            <p></p>
            Financial Accounts: <span class="ui tiny icon transparent input">
                <input type="text" spellcheck="false" id="ai-fa" value="暂无">
            </span>
            Country Affiliations: <span class="ui tiny icon transparent input">
                <input type="text" spellcheck="false" id="ai-ca" value="暂无">
            </span>
			Known Targets: <span class="ui tiny icon transparent input">
                <input type="text" spellcheck="false" id="ai-kt" value="暂无">
            </span>
			<p></p>
			Actor Suspected Point of Origin: <span class="ui tiny icon transparent input">
                <input type="text" spellcheck="false" id="ai-aspo" value="暂无">
            </span>
            Infrastructure IPv4s: <span class="ui tiny icon transparent input">
                <input type="text" spellcheck="false" id="ai-ii" value="暂无">
            </span>
            Infrastructure FQDNs: <span class="ui tiny icon transparent input">
                <input type="text" spellcheck="false" id="ai-if" value="暂无">
            </span>

          </div>
        </div>
      </div>
      <div class="actions">
        <div class="ui green right pointing label" id="save-tip">

        </div>
        <div class="ui secondary disabled right labeled icon button" id="submit-change" onclick="detailSaved()">
          保存
          <i class="checkmark icon"></i>
        </div>
      </div>
    </div>

    <div class="login ui tiny modal">
    <div class="content">
        <div class="ui middle aligned center aligned grid">
          <div class="column">
            <h2 class="ui teal header">
              <div class="content">
                Log-in to your account
              </div>
            </h2>
            <form class="ui large form">
              <div class="ui segment">
                <div class="field">
                  <div class="ui left icon input">
                    <i class="user icon"></i>
                    <input type="text" name="email" spellcheck="false" placeholder="E-mail address">
                  </div>
                </div>
                <div class="field">
                  <div class="ui left icon input">
                    <i class="lock icon"></i>
                    <input type="password" name="password" placeholder="Password">
                  </div>
                </div>
                <div class="ui fluid large teal submit button">Login</div>
              </div>

              <div class="ui error message"></div>

            </form>

            <div class="ui message">
              New to us? <a href="#">Sign Up</a>
            </div>
          </div>
        </div>
    </div>
    </div>
</div>

<script type="text/javascript">
$(document).ready(function() {
    var table = $('#example').DataTable(
     {
        "processing": true,
        "paging": true,
        "serverSide": true,
        "ordering": false, // 禁止排序
        "bAutoWidth": true,
        "ajax": {
            url: "http://127.0.0.1:8989/api",
            type: 'POST'
        },
        "aoColumnDefs":[{"aTargets":[3],"mRender":function(data,type,full){
                     return "<a href=\"http://www.baidu.com/\" target=\"_\">"+data+"</a>    "}
                    },{"aTargets":[6],sWidth:"13%","className":"center aligned","mRender":function(data,type,full){
                     return "<div class=\"ui tiny button\" onclick=\"readOnlyDetails('"+full[0]+"');\" >详情</div>"}
                    }]
    }
    );
    // $('#example tbody').on("click","tr",function () {
    //     var data = table.row(this).data();
    //     alert(data);
    // });
    // table.search( 'software' );
    // table.Rows.Add(newobject[] { null, "a", "b", "c" }); 
} );

function readOnlyDetails(data){


    $.ajax({
      type: 'POST',
      url: "http://127.0.0.1:8989/api/details",
      data: {"md5":data},
      success: function(data){
        assignDetails(data);
      },
      dataType: "json"
    });    


}
// open login modal
function toggleLogin() {
     $('.login.ui.tiny.modal')
      .modal('show')
    ;
}
function toggleUrlList(obj) {
    $(obj).toggleClass('minus');
    $(obj).toggleClass('plus');
    $(obj).parent().parent('div').next().toggle();
}
function detailModified() {
  $('#submit-change').toggleClass("disabled",false);
  $('#save-tip').hide();
}
function detailSaved() {
  $('#submit-change').toggleClass("disabled",true);
  $('#save-tip').text("数据修改成功！");
  $('#save-tip').show();

  postDetails();
}

function addLabel() {

  $('#labellist').append("<a class=\"ui label\"><span>"+$('#newlabel').val()+"</span><i class=\"delete icon\" onclick=\"delLabel(this)\"></i></a>");
  $('#newlabel').val("");
  detailModified();
}

function delLabel(obj) {
  $(obj).parent('a').remove();
  detailModified();
}

function tlpchange(val) {
  var obj = $('#m-tlp');
  switch(val){
    case "不可共享":
      obj.toggleClass("red",true);
      obj.toggleClass("orange",false);
      obj.toggleClass("green",false);
      obj.toggleClass("white",false); break;
    case "组织内共享":
      obj.toggleClass("red",false);
      obj.toggleClass("orange",true);
      obj.toggleClass("green",false);
      obj.toggleClass("white",false); break;
    case "组织外限制共享":
      obj.toggleClass("red",false);
      obj.toggleClass("orange",false);
      obj.toggleClass("green",true);
      obj.toggleClass("white",false); break;
    case "广泛共享":
      obj.toggleClass("red",false);
      obj.toggleClass("orange",false);
      obj.toggleClass("green",false);
      obj.toggleClass("white",true); break;
    
  }
}


function assignDetails(data){
    $('#a-title').val(data.report[1]);
    $("#title").addClass("disabled");
    $("#aid").show();
    $('#m-from').val(data.report[3]);
    $('#m-cdate').text(data.report[2]);
    $('#m-md5').text(data.report[0]);
    $('#m-status').text(data.report[4]);


    // $('#m-tlp').text(tlp);
    $('#TLPdropdown')
		.dropdown('set selected',data.report[5])
	;
    
	tlpchange(data.report[5]);
    $('#m-tlp').attr("val",data.report[5]);


    $('#labellist').empty();
    var tags = data.labels.split(';');
    for(item in tags){
       $('#labellist').append('<a class="ui label"><span>'+tags[item]+'</span><i class="delete icon" onclick="delLabel(this)"></i></a>'); 
    }
    var abs = data.abstract!=null? data.abstract : "暂无摘要";
    var des = data.desc!=null? data.desc : "暂无描述";
    $('#ai-abstract').val(abs);
    $('#m-desc').val(des);

    // assignUrls(data.urls);

    // assignActorList(data.actors);

    
    
    toggleDetail();

    
}
function toggleDetail() {
	$('.longer.details.modal')
      .modal({closable: false})
      .modal('show')
    ;
    $('#save-tip').hide();
    $('#TLPdropdown')
      .dropdown()
    ;
    $('#cfdropdown')
      .dropdown()
    ;
    $('#atpdropdown')
      .dropdown()
    ;
    $('#mtvdropdown')
      .dropdown()
    ;

}
function assignActorList(actors) {

	var table1 = $('#Actor-table').DataTable(
     {
        "destroy": true,
        "data": actors,
        "bFilter": false,    //去掉搜索框方法
        "paging": false,
        "bLengthChange": false,   //去掉每页显示多少条数据方法
        "ordering": false, // 禁止排序
        // "ajax": {
        //     url: "http://localhost//test/api.php",
        //     type: 'POST'
        // },
        "aoColumnDefs":[
        // {"aTargets":[0],"mRender":function(data,type,full){
        //                 var actorname = '<div class="ui link list">';
        //                 for(item in data){
        //                    actorname += '<a class="item">'+data[item]+'</a>';
        //                 }
        //                 actorname += "</div>";
        //                 return actorname;
        //             }}
        	{"aTargets":[-1],"className":"center aligned","mRender":function(data,type,full){
                        return '<div class="ui tiny button" onclick="">删除</div>';
                    }}
                    ]
    }
    );
}
function assignUrls(urls){
	var columns = [
                    "md5",
                    "domains","ipv4"
                    // ,"actors","reports"
                    ];
    var htmlcode = "";
    for(item in urls){
        
        htmlcode += '<div class="item"> \
                  <a><i class="plus circle icon" onclick="toggleUrlList(this)"></i></a> \
                  <a class="item" href="'+urls[item].url+'" target="_">'+urls[item].url+'</a> \
              </div>'; 
        htmlcode += '<table class="ui celled compact padded table list-hidden"><thead><tr><th>IOC_MD5</th><th>IOC_DOMAIN</th><th>IOC_IPV4</th><th>Related Actors</th><th>Related Reports</th></tr></thead><tbody><tr>';
        
        // htmlcode += '<td><div class="ui link list"><a class="item">'+data.urls[item]['md5']+'</a></div></td>';
        for(var i=0; i<columns.length; i+=1){
            htmlcode += '<td><div class="ui link list">';
            // console.log(data.urls);
            var arr = str2Array(urls[item][columns[i]]);
            for(j in arr){
                // console.log(data.urls[item][columns[i]][j]);
                htmlcode += '<a class="item">'+arr[j]+'</a>';
            }
            htmlcode += '</div></td>';
        }
        htmlcode += '<td><div class="ui link list"><a class="item">'+urls[item]['actors']+'</a></div></td>';
        htmlcode += '<td><div class="ui link list"><a class="item">'+urls[item]['reports']+'</a></div></td>';
        htmlcode += '</tr></tbody></table>\n';
    }
    $('#m-urls').empty();
    $('#m-urls').append(htmlcode);

}
function str2Array(origin){
	if(origin == null || origin == '[]')
		return new Array("暂无");
	var str  =  origin.replace(/[\s+|\]|\[|\']/g,"");    
	var strArray = str.split(',');
	return strArray;
}

function clearModalforadd(){
	$("[id^='ai-']").val("");
	$("#title").removeClass("disabled");
	$("#a-title").val("");
	$("#a-crit").val("");
	$("#a-cdate").val("");
	$("#aid").hide();
	$("#a-tlp").text("");	$("#a-cf").text("");
	$("#a-at").text("");	$("#a-m").text("");
	$("#a-ci").val("");
}

function toggleAdd() {
	clearModalforadd();
	toggleDetail();
}
</script>
</body>
</html>